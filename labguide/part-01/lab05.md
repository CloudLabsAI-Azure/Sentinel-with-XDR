## Lab 05 - Ingest Logs from Microsoft Defender for Endpoint

## Lab Overview
Microsoft Defender for Endpoint is an enterprise endpoint security platform designed to help enterprise networks prevent, detect, investigate, and respond to advanced threats. Fetch alerts generated in Microsoft Defender for Endpoint to Microsoft Sentinel so that you can effectively analyze security events.

## Lab scenario
In this lab, you will ingest Logs from Microsoft Defender for Endpoint is to collect, process, and analyze security event logs from Microsoft Defender for Endpoint to enhance threat detection and response within the organization.

## Lab objectives (Duration: 120 minutes)

In this lab, you will complete the following tasks:
- Task 1: Explore defender for ingest data
- Task 2: Verify installation of Defender for Endpoint on a machine
- Task 3: Ingesting data to Sentinel from Microsoft Defender
- Task 4: Install Microsoft Defender for Endpoint to sentinel
- Task 5: Set up the data connector to ingest logs to workspace
- Task 6: View data ingested into Microsoft Sentinel

## Architecture Diagram

   ![](../media/lab07.png)

### Task 1: Explore defender for ingest data 

In this task, you will explore ingesting logs from Microsoft Defender for Cloud.

1. On Azure Portal page, in **Search resources, services and docs (G+/)** box at the top of the portal, enter **Microsoft Defender for Cloud**, and then select **Microsoft Defender for Cloud** under services.

1.  From **Microsoft Defender for Cloud | Overview** blade, under **Management** section select **Environment settings** and click on the **subscription**.

     ![Picture 1](../media/image_50.png)

1. Click on **Defender Plans** on left blade, then  click on **Settings&Monitoring** inbetween the page at top left.

    ![](../media/image_49.png)

1. In the status of the Endpoint protection component, select **On** to enable the integration with Microsoft Defender for Endpoint. If its already enable then no need to change.

   ![Picture 1](../media/dd7.png)
   
   > Automatically onboard your Windows machines to Defender for Endpoint, Detect any previous installations of Defender for Endpoint and reconfigure them to integrate with Defender for Cloud. Onboarding might take up to 1 hour.

1. Select Continue and Save to save your settings.

### Task 2: Verify installation of Defender for Endpoint on a machine

1. From the start menu search and select the **Services**, will find Microsoft Monitoring Agent is Running.

   ![Picture 1](../media/image_46.png)

   >**Note**: This may take 1 - 2 hours, please proceed to the next task. You can return to this step later to verify.

### Task 3: Install Microsoft Defender for Endpoint to sentinel

1. On Azure Portal page, in **Search resources, services and docs (G+/)** box at the top of the portal, enter **Microsoft Sentinel**, and then select **Microsoft Sentinel** under services.

1. On **Microsoft Sentinel** blade, click on **sentinelworkspace**, to ingest Microsoft Defender data into Sentinel, you need to utilize the connectors provided by 
   Sentinel.

1. From the left navigation pane select **Data connectors** under **Configuration** section and click on **Go to content hub**.
   ![Picture 1](../media/image_44.png)

1. Search and select the Microsoft Defender for Endpoint and click on install to get the logs into the Sentinel.

   ![Picture 1](../media/image_51.png)

1. Back on **Microsoft Sentinel | Data connectors** page and from left navigation pane select **Analytics** under **Configuration** section.

1. Click on **Analytics** under **Configuration** section, to setup a analytics rule to get alerts as a incident in the Sentinel and under **Rule templates** tab search for **Microsoft Defender for Endpoint**. Select any desired template and click on **Create rule**.
   
1. Click on **Automated response** then **Review + create** and click on **Save**.

1. The configured rule will now generate alerts when triggered by relevant events.

1. To view the incidents generated by the rule, go to the Incidents tab in Microsoft Sentinel. Here, you'll find details about incidents triggered by the alert rule.   

### Task 4: Set up the data connector to ingest logs to workspace

1. In Microsoft Sentinel, select Data connectors.

1. Search for and select the **Microsoft Defender for Endpoint** connector.

1. In the details pane for the connector, select Open connector page.

1. On the **Instructions** page, under configuration, click on **connect** to establish connection between Endpoint and sentinel
  
   >**Note**: Wait for atleast 15 mins and proceed to next task.

### Task 5: View data ingested into Microsoft Sentinel

1. In Microsoft Sentinel, select Data connectors.

1. Search for and select the **Microsoft Defender for Endpoint** data connector.

1. In the details pane for the connector, select Open connector page.

1. Review the Status of the data connector. It should be Connected.

1. Scroll down and select **Go to log analytics**.

1. In the query pane, run the default query, to view the activity data ingested into the workspace.

## Review
In this lab, you have completed the configuration setup required to Ingest logs from Microsoft Defender for endpoint to Sentinel.
